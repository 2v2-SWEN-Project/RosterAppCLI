{% extends "layout.html" %}
{% block title %}Weekly Staff Roster â€” Scheduloid{% endblock %}

{% block nav_actions %}
<a href="{{ url_for('index_views.admin_dashboard') }}" class="link">Back to Dashboard</a>
{% endblock %}

{% block content %}
<!-- Page Header -->
<section class="card">
    <div class="card-header">
        <h1 class="card-title">Weekly Staff Roster</h1>
        <p class="card-subtitle">Schedule for {{ week_start_display }} to {{ week_end_display }}</p>
    </div>
</section>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <ul class="flash-messages" style="margin-bottom: 1.5rem;">
      {% for category, message in messages %}
        <li class="flash {{ category }}">{{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}
{% endwith %}

<!-- Schedule Selector -->
<section class="card">
    <div class="card-header">
        <h2 class="card-title">Schedule Selection</h2>
    </div>
    <div class="card-body">
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; align-items: end;">
            <div class="form-group" style="margin-bottom: 0;">
                <label for="schedule_type">Schedule Type</label>
                <select id="schedule_type" class="schedule-dropdown">
                    {% if auto_schedules %}
                    <option value="auto" {% if current_schedule_type == 'auto' %}selected{% endif %}>Auto-Generated</option>
                    {% endif %}
                    {% if manual_schedules %}
                    <option value="manual" {% if current_schedule_type == 'manual' %}selected{% endif %}>Manual</option>
                    {% endif %}
                </select>
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <label for="schedule_id">Select Schedule</label>
                <select id="schedule_id" class="schedule-dropdown">
                    {% if current_schedule_type == 'auto' %}
                    {% for schedule in auto_schedules %}
                    <option value="{{ schedule.id }}" {% if selected_schedule.id == schedule.id %}selected{% endif %}>
                        {{ schedule.name }} {% if schedule.strategy_used %}({{ schedule.strategy_used }}){% endif %}
                    </option>
                    {% endfor %}
                    {% else %}
                    {% for schedule in manual_schedules %}
                    <option value="{{ schedule.id }}" {% if selected_schedule.id == schedule.id %}selected{% endif %}>
                        {{ schedule.name }}
                    </option>
                    {% endfor %}
                    {% endif %}
                </select>
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <label for="week_date">Jump to Week</label>
                <input type="date" id="week_date" class="week-input">
            </div>
        </div>
    </div>
</section>

<!-- Week Navigation -->
<section class="card">
    <div class="card-header">
        <h2 class="card-title">Week Navigation</h2>
    </div>
    <div class="card-body">
        <div class="flex-row" style="justify-content: space-between;">
            <a href="?week_start={{ prev_week }}&schedule_id={{ selected_schedule.id }}" class="btn">Previous Week</a>
            <div class="flex-row">
                <div class="stat-box" style="min-width: 120px;">
                    <p class="stat-label">Total Shifts</p>
                    <p class="stat-value">{{ total_shifts }}</p>
                </div>
                <div class="stat-box teal" style="min-width: 120px;">
                    <p class="stat-label">Schedule</p>
                    <p class="stat-value" style="font-size: 1rem;">{{ selected_schedule.name if selected_schedule else 'None' }}</p>
                </div>
            </div>
            <a href="?week_start={{ next_week }}&schedule_id={{ selected_schedule.id }}" class="btn">Next Week</a>
        </div>
    </div>
</section>

<!-- Weekly Schedule Grid -->
{% if schedule_by_day %}
<section class="card">
    <div class="card-header">
        <h2 class="card-title">Weekly Schedule</h2>
    </div>
    <div class="card-body" style="padding: 0;">
        <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 0; border-top: 1px solid #334155;">
            {% for date, day_data in schedule_by_day.items() %}
            <div style="border-right: 1px solid #334155; {% if loop.last %}border-right: none;{% endif %}">
                <div style="background: #0f172a; padding: 1rem; text-align: center; border-bottom: 2px solid #3b82f6;">
                    <p style="margin: 0; color: #60a5fa; font-weight: 700;">{{ day_data.day_name }}</p>
                    <p style="margin: 0.25rem 0 0 0; color: #94a3b8; font-size: 0.85rem;">{{ day_data.short_date }}</p>
                </div>
                <div style="padding: 0.75rem; min-height: 300px; display: flex; flex-direction: column; gap: 0.5rem;">
                    {% if day_data.shifts %}
                    {% for shift in day_data.shifts %}
                    <div style="background: #0f172a; border: 1px solid #334155; border-radius: 4px; padding: 0.75rem;">
                        <p style="margin: 0 0 0.25rem 0; color: #60a5fa; font-weight: 600; font-size: 0.85rem;">{{ shift.start_time }}-{{ shift.end_time }}</p>
                        <p style="margin: 0; color: #e2e8f0; font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ shift.staff_name }}</p>
                        <p style="margin: 0.25rem 0 0 0; color: #64748b; font-size: 0.75rem;">{{ shift.duration }}h</p>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div style="flex: 1; display: flex; align-items: center; justify-content: center;">
                        <p style="margin: 0; color: #64748b; font-size: 0.85rem;">No shifts</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>
{% else %}
<section class="card">
    <div class="card-header">
        <h2 class="card-title">Weekly Schedule</h2>
    </div>
    <div class="card-body">
        <div style="background: #0f172a; border-radius: 8px; padding: 3rem; text-align: center;">
            <p style="margin: 0; color: #94a3b8; font-size: 1rem;">No schedule data available for this week.</p>
        </div>
    </div>
</section>
{% endif %}

<script>
document.getElementById('schedule_type').addEventListener('change', function(e) {
  window.location.href = '?schedule_type=' + this.value + '&week_start=' + document.getElementById('week_date').value;
});

document.getElementById('schedule_id').addEventListener('change', function(e) {
  window.location.href = '?schedule_id=' + this.value + '&week_start=' + document.getElementById('week_date').value;
});

document.getElementById('week_date').addEventListener('change', function(e) {
  if (this.value) {
    const scheduleId = document.getElementById('schedule_id').value;
    window.location.href = '?week_start=' + this.value + '&schedule_id=' + scheduleId;
  }
});

document.getElementById('week_date').valueAsDate = new Date('{{ week_start }}');
</script>
{% endblock %}
